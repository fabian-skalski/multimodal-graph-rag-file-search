services:
  # Fluentd for centralized logging
  fluentd:
    build:
      context: .
      dockerfile: Dockerfile.fluentd
    container_name: graph-rag-fluentd
    restart: unless-stopped
    ports:
      - "24224:24224"
      - "24224:24224/udp"
    volumes:
      - ./fluent.conf:/fluentd/etc/fluent.conf:ro
      - ./logs:/fluentd/log
    networks:
      - graph-rag-network

  # Neo4j graph database
  neo4j:
    image: neo4j:5.15-community
    container_name: graph-rag-neo4j
    restart: unless-stopped
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=${NEO4J_USERNAME:-neo4j}/${NEO4J_PASSWORD:-neo4j_password}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_server_memory_heap_initial__size=128m
      - NEO4J_server_memory_heap_max__size=256m
      - NEO4J_server_memory_pagecache_size=128m
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
    shm_size: '128m'
    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 256M
    networks:
      - graph-rag-network

  # Redis for distributed rate limiting
  redis:
    image: redis:7-alpine
    container_name: graph-rag-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:24224
        tag: redis
        fluentd-async: "true"
        fluentd-retry-wait: "1s"
        fluentd-max-retries: "10"
        fluentd-buffer-limit: "10485760"
    depends_on:
      - fluentd
    networks:
      - graph-rag-network

  # Cache service (document store)
  cache:
    build:
      context: ./services/cache_service
      dockerfile: Dockerfile
    container_name: graph-rag-cache
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=${NEO4J_USERNAME:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-neo4j_password}
      - NEO4J_DATABASE=${NEO4J_DATABASE:-neo4j}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      fluentd:
        condition: service_started
      neo4j:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:24224
        tag: cache
        fluentd-async: "true"
        fluentd-retry-wait: "1s"
        fluentd-max-retries: "10"
        fluentd-buffer-limit: "10485760"
    networks:
      - graph-rag-network

  # Rate limiter service
  rate-limiter:
    build:
      context: ./services/rate_limiter_service
      dockerfile: Dockerfile
    container_name: graph-rag-rate-limiter
    restart: unless-stopped
    ports:
      - "8002:8002"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # Default bucket configuration (idempotent on startup)
      - RATE_LIMIT_BUCKET_ID=${RATE_LIMIT_BUCKET_ID:-default}
      - RATE_LIMIT_CAPACITY=${RATE_LIMIT_CAPACITY:-128000}
      - RATE_LIMIT_REFILL_RATE=${RATE_LIMIT_REFILL_RATE:-2133.33}
    depends_on:
      fluentd:
        condition: service_started
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:24224
        tag: rate-limiter
        fluentd-async: "true"
        fluentd-retry-wait: "1s"
        fluentd-max-retries: "10"
        fluentd-buffer-limit: "10485760"
    networks:
      - graph-rag-network

  # LLM operations service
  llm-service:
    build:
      context: ./services/llm_service
      dockerfile: Dockerfile
    container_name: graph-rag-llm-service
    restart: unless-stopped
    ports:
      - "8003:8003"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL}
      - OPENAI_QUERY_PARAMS=${OPENAI_QUERY_PARAMS}
      - OPENAI_INFERENCE_MODEL_NAME=${OPENAI_INFERENCE_MODEL_NAME}
      - RATE_LIMITER_URL=http://rate-limiter:8002
      - RATE_LIMIT_BUCKET_ID=${RATE_LIMIT_BUCKET_ID:-default}
      - RATE_LIMIT_TIMEOUT=${RATE_LIMIT_TIMEOUT:-65.0}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      fluentd:
        condition: service_started
      rate-limiter:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:24224
        tag: llm-service
        fluentd-async: "true"
        fluentd-retry-wait: "1s"
        fluentd-max-retries: "10"
        fluentd-buffer-limit: "10485760"
    networks:
      - graph-rag-network

  # Document processor service
  document-processor:
    build:
      context: ./services/document_processor_service
      dockerfile: Dockerfile
    container_name: graph-rag-document-processor
    restart: unless-stopped
    ports:
      - "8004:8004"
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      - fluentd
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:24224
        tag: document-processor
        fluentd-async: "true"
        fluentd-retry-wait: "1s"
        fluentd-max-retries: "10"
        fluentd-buffer-limit: "10485760"
    networks:
      - graph-rag-network

  # Graph processor service
  graph-processor:
    build:
      context: ./services/graph_processor_service
      dockerfile: Dockerfile
    container_name: graph-rag-graph-processor
    restart: unless-stopped
    ports:
      - "8005:8005"
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      - fluentd
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:24224
        tag: graph-processor
        fluentd-async: "true"
        fluentd-retry-wait: "1s"
        fluentd-max-retries: "10"
        fluentd-buffer-limit: "10485760"
    networks:
      - graph-rag-network

  # Orchestrator service (FastAPI)
  orchestrator:
    build:
      context: .
      dockerfile: services/orchestrator_service/Dockerfile
    container_name: graph-rag-orchestrator
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - CACHE_SERVICE_URL=http://cache:8001
      - RATE_LIMITER_URL=http://rate-limiter:8002
      - LLM_SERVICE_URL=http://llm-service:8003
      - DOCUMENT_PROCESSOR_URL=http://document-processor:8004
      - GRAPH_PROCESSOR_URL=http://graph-processor:8005
      - CHUNK_SIZE=${CHUNK_SIZE}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP}
      - RATE_LIMIT_BUCKET_ID=${RATE_LIMIT_BUCKET_ID:-default}
      - RATE_LIMIT_CAPACITY=${RATE_LIMIT_CAPACITY:-128000}
      - RATE_LIMIT_REFILL_RATE=${RATE_LIMIT_REFILL_RATE:-2133.33}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./test_docs:/app/test_docs:ro
    depends_on:
      fluentd:
        condition: service_started
      cache:
        condition: service_healthy
      rate-limiter:
        condition: service_healthy
      llm-service:
        condition: service_healthy
      document-processor:
        condition: service_healthy
      graph-processor:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:24224
        tag: orchestrator
        fluentd-async: "true"
        fluentd-retry-wait: "1s"
        fluentd-max-retries: "10"
        fluentd-buffer-limit: "10485760"
    networks:
      - graph-rag-network

volumes:
  neo4j-data:
    driver: local
  neo4j-logs:
    driver: local
  redis-data:
    driver: local

networks:
  graph-rag-network:
    driver: bridge
